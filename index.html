<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Base Ping (3 butonlu)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0 }
      .card { background:rgba(255,255,255,.06); padding:24px; border-radius:16px; width:min(92vw,600px); box-shadow:0 15px 40px rgba(0,0,0,.3) }
      .row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0; flex-wrap:wrap }
      .btn { background:rgba(255,255,255,.10); border:none; padding:10px 14px; border-radius:12px; color:#fff; cursor:pointer; transition:all .2s }
      .btn:disabled { opacity:.5; cursor:not-allowed }
      .btn-ghost { background:rgba(255,255,255,.08) }
      .btn-outline { background:transparent; border:1px solid rgba(255,255,255,.2) }
      .btn-active { background:#3b82f6 }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all }
      small { opacity:.75 }
      a { color:#a5b4fc }
      .contracts { display:flex; gap:8px; flex-wrap:wrap }
      .contracts .contract-btn { padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); cursor:pointer }
      .contracts .contract-btn.active { background:#22c55e; border-color:#22c55e; color:#0b1220 }
      .muted { opacity:.8 }
      .kpi { display:flex; gap:12px; flex-wrap:wrap }
      .kpi .pill { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:999px; padding:6px 10px; font-size:12px }
    </style>
    <!-- Ethers v5 UMD -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  </head>
  <body>
    <div class="card">
      <h2 style="margin:0 0 6px">Base Ping</h2>
      <p class="muted" style="margin:0 0 14px">
        Aşağıdan kontratı seç → <strong>Cüzdanı Bağla</strong> → <strong>Ping</strong>.
        Gerekirse ağ otomatik <em>Base Mainnet</em>’e alınır. <small>(Bazı kontratlar sayaç/tek-sefer kontrolünü desteklemeyebilir.)</small>
      </p>

      <!-- Kontrat seçim butonları -->
      <div class="contracts" id="contracts">
        <button class="contract-btn active" data-addr="0x88b04a6ce778b3eab658a6f5692a4714a60eb136">Kontrat</button>
        <button class="contract-btn" data-addr="0xbea9b733313312ffaaf587a8b4523c2466fc20a3">Kontrat</button>
        <button class="contract-btn" data-addr="0xf5a60f454108411c5ba5a4dad5998793781c7565">Kontrat</button>
      </div>

      <div class="row">
        <div style="min-width:240px">
          <div><small>Seçili kontrat</small></div>
          <div id="contractAddr" class="mono">—</div>
        </div>
        <div>
          <button id="connect" class="btn btn-outline">Cüzdanı Bağla</button>
          <button id="ping" class="btn btn-ghost" disabled>Ping</button>
        </div>
      </div>

      <div class="row kpi">
        <div class="pill"><small>Bağlı cüzdan: </small><span id="account" class="mono">—</span></div>
        <div class="pill"><small>Sayım: </small><span id="counter">—</span></div>
      </div>

      <div style="margin-top:8px">
        <small>Durum: <span id="status">Hazır</span></small><br/>
        <small>Tx: <a id="tx" href="#" target="_blank" rel="noreferrer">—</a></small>
      </div>
    </div>

    <script>
      (function() {
        const CHAIN_ID_HEX = "0x2105"; // Base Mainnet 8453
        const RPC_URL = "https://mainnet.base.org";

        // DOM
        const statusEl = document.getElementById("status");
        const accountEl = document.getElementById("account");
        const counterEl = document.getElementById("counter");
        const txEl = document.getElementById("tx");
        const connectBtn = document.getElementById("connect");
        const pingBtn = document.getElementById("ping");
        const contractAddrEl = document.getElementById("contractAddr");
        const contractsWrap = document.getElementById("contracts");

        // ABI (PingOnce tipi). Bazı kontratlarda uniquePings/hasPinged yoksa try/catch ile atlanır.
        const ABI = [
          {"inputs":[],"name":"ping","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[],"name":"uniquePings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
          {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasPinged","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
          {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"}],"name":"Ping","type":"event"}
        ];

        // State
        let currentAddress = document.querySelector(".contract-btn.active").dataset.addr;
        let provider, signer, contract;

        contractAddrEl.textContent = currentAddress;

        // Kontrat butonları tıklama
        contractsWrap.addEventListener("click", async (e) => {
          const btn = e.target.closest(".contract-btn");
          if (!btn) return;
          document.querySelectorAll(".contract-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentAddress = btn.dataset.addr;
          contractAddrEl.textContent = currentAddress;
          await initContract(); // seçince güncelle
        });

        async function ensureBaseNetwork() {
          const eth = window.ethereum;
          if (!eth) throw new Error("Cüzdan bulunamadı");
          const chainId = await eth.request({ method: "eth_chainId" });
          if (chainId !== CHAIN_ID_HEX) {
            try {
              await eth.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: CHAIN_ID_HEX }],
              });
            } catch (err) {
              if (err.code === 4902) {
                await eth.request({
                  method: "wallet_addEthereumChain",
                  params: [{
                    chainId: CHAIN_ID_HEX,
                    chainName: "Base Mainnet",
                    nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                    rpcUrls: [RPC_URL],
                    blockExplorerUrls: ["https://basescan.org/"],
                  }],
                });
              } else {
                throw err;
              }
            }
          }
        }

        async function initContract() {
          try {
            if (!provider) {
              // read-only sayaç için public provider
              const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
              contract = new ethers.Contract(currentAddress, ABI, rp);
              await refreshCounter(true);
              pingBtn.disabled = true;
              return;
            }
            await ensureBaseNetwork();
            contract = new ethers.Contract(currentAddress, ABI, signer);
            await refreshCounter();
            await applyHasPingedGate();
            pingBtn.disabled = false;
          } catch (e) {
            console.warn("initContract uyarı:", e);
            counterEl.textContent = "—";
            pingBtn.disabled = false; // en az ping'e izin ver
            statusEl.textContent = "Bağlandı (sayaç/hasPinged desteklenmeyebilir).";
          }
        }

        async function applyHasPingedGate() {
          try {
            const me = await signer.getAddress();
            if (typeof contract.hasPinged !== "function") return;
            const already = await contract.hasPinged(me);
            if (already) {
              pingBtn.disabled = true;
              statusEl.textContent = "Bu cüzdan zaten ping attı ✅";
            } else {
              pingBtn.disabled = false;
              statusEl.textContent = "Bağlandı. Ping atabilirsin.";
            }
          } catch {/* sessiz */}
        }

        async function refreshCounter(readOnlyOnly=false) {
          try {
            if (typeof contract.uniquePings !== "function") { counterEl.textContent = "—"; return; }
            const v = await contract.uniquePings();
            counterEl.textContent = v.toString() + " unique pings";
          } catch (e) {
            if (!readOnlyOnly) {
              try {
                const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
                const rc = new ethers.Contract(currentAddress, ABI, rp);
                const v = await rc.uniquePings();
                counterEl.textContent = v.toString() + " unique pings";
              } catch { counterEl.textContent = "—"; }
            } else {
              counterEl.textContent = "—";
            }
          }
        }

        async function connect() {
          if (!window.ethereum) {
            alert("Lütfen MetaMask (veya bir EVM cüzdanı) kur.");
            return;
          }
          statusEl.textContent = "Cüzdan bağlantısı bekleniyor…";
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          accountEl.textContent = accounts[0] || "—";
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();

          await initContract();

          if (window.ethereum && !window.__basePingBound) {
            window.__basePingBound = true;
            window.ethereum.on("accountsChanged", () => connect());
            window.ethereum.on("chainChanged", () => location.reload());
          }
        }

        async function ping() {
          try {
            if (!contract || !signer) { statusEl.textContent = "Önce cüzdan bağla."; return; }
            await ensureBaseNetwork();
            const me = await signer.getAddress();
      
            // 1) (Varsa) tek-sefer kapısı
            try {
              if (typeof contract.hasPinged === "function") {
                const already = await contract.hasPinged(me);
                if (already) {
                  pingBtn.disabled = true;
                  statusEl.textContent = "Bu cüzdan zaten ping attı ✅";
                  return;
                }
              }
            } catch {}
      
            // 2) callStatic: simülasyon geçmezse asla gönderme
            try {
              await contract.callStatic.ping({ from: me });
            } catch (e) {
              const raw = (e?.error?.message || e?.data?.message || e?.reason || e?.message || "").toLowerCase();
              if (raw.includes("already") || raw.includes("once")) {
                statusEl.textContent = "Bu kontratta bu cüzdan için ping'e izin yok (muhtemelen zaten ping attın).";
              } else if (raw.includes("owner") || raw.includes("onlyowner")) {
                statusEl.textContent = "Bu kontrat ping için yetki kısıtı uyguluyor.";
              } else {
                statusEl.textContent = "Simülasyon başarısız: Kontrat bu çağrıyı reddediyor.";
              }
              return;
            }
      
            // 3) estimateGas: başarısızsa gönderme (blind fallback yok!)
            let gasLimit;
            try {
              const est = await contract.estimateGas.ping({ from: me });
              gasLimit = est.mul(120).div(100); // +%20 pay
            } catch {
              statusEl.textContent = "Gas tahmini yapılamadı; gönderim iptal edildi.";
              return;
            }
      
            // 4) Gönderim
            statusEl.textContent = "İşlem gönderiliyor… Cüzdandan onayla.";
            const tx = await contract.ping({ gasLimit });
            txEl.textContent = tx.hash;
            txEl.href = `https://basescan.org/tx/${tx.hash}`;
            statusEl.textContent = "Onay bekleniyor…";
            await tx.wait();
            statusEl.textContent = "Onaylandı! Teşekkürler.";
            await refreshCounter();
            await applyHasPingedGate();
      
          } catch (e) {
            const msg = (e?.data?.message || e?.message || "").toLowerCase();
            if (msg.includes("already")) {
              statusEl.textContent = "Bu cüzdan zaten ping attı ✅";
              pingBtn.disabled = true;
            } else if (msg.includes("user rejected")) {
              statusEl.textContent = "İşlem iptal edildi.";
            } else if (msg.includes("call_exception")) {
              statusEl.textContent = "Kontrat çağrısı revert etti (status=0).";
            } else {
              statusEl.textContent = "İşlem reddedildi/başarısız: " + (e?.data?.message || e?.message || "Bilinmeyen hata");
            }
          }
        }
        
        // Events
        connectBtn.addEventListener("click", connect);
        pingBtn.addEventListener("click", ping);

        // İlk yüklemede seçili kontrat adresini ve sayaçı dene
        (async () => {
          contractAddrEl.textContent = currentAddress;
          try {
            const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
            const rc = new ethers.Contract(currentAddress, ABI, rp);
            const v = await rc.uniquePings().catch(()=>null);
            if (v !== null) counterEl.textContent = v.toString() + " unique pings";
          } catch {}
        })();
      })();
    </script>
  </body>
</html>
