<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Base Ping (3 butonlu)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0 }
      .card { background:rgba(255,255,255,.06); padding:24px; border-radius:16px; width:min(92vw,600px); box-shadow:0 15px 40px rgba(0,0,0,.3) }
      .row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0; flex-wrap:wrap }
      .btn { background:rgba(255,255,255,.10); border:none; padding:10px 14px; border-radius:12px; color:#fff; cursor:pointer; transition:all .2s }
      .btn:disabled { opacity:.5; cursor:not-allowed }
      .btn-ghost { background:rgba(255,255,255,.08) }
      .btn-outline { background:transparent; border:1px solid rgba(255,255,255,.2) }
      .btn-active { background:#3b82f6 }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all }
      small { opacity:.75 }
      a { color:#a5b4fc }
      .contracts { display:flex; gap:8px; flex-wrap:wrap }
      .contracts .contract-btn { padding:8px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06); cursor:pointer }
      .contracts .contract-btn.active { background:#22c55e; border-color:#22c55e; color:#0b1220 }
      .muted { opacity:.8 }
      .kpi { display:flex; gap:12px; flex-wrap:wrap }
      .kpi .pill { background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15); border-radius:999px; padding:6px 10px; font-size:12px }
    </style>
    <!-- Ethers v5 UMD -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  </head>
  <body>
    <div class="card">
      <h2 style="margin:0 0 6px">Base Ping</h2>
      <p class="muted" style="margin:0 0 14px">
        AÅŸaÄŸÄ±dan kontratÄ± seÃ§ â†’ <strong>CÃ¼zdanÄ± BaÄŸla</strong> â†’ <strong>Ping</strong>.
        Gerekirse aÄŸ otomatik <em>Base Mainnet</em>â€™e alÄ±nÄ±r. <small>(BazÄ± kontratlar sayaÃ§/tek-sefer kontrolÃ¼nÃ¼ desteklemeyebilir.)</small>
      </p>

      <!-- Kontrat seÃ§im butonlarÄ± -->
      <div class="contracts" id="contracts">
        <button class="contract-btn active" data-addr="0x88b04a6ce778b3eab658a6f5692a4714a60eb136">Kontrat</button>
        <button class="contract-btn" data-addr="0xbea9b733313312ffaaf587a8b4523c2466fc20a3">Kontrat</button>
        <button class="contract-btn" data-addr="0xf5a60f454108411c5ba5a4dad5998793781c7565">Kontrat</button>
      </div>

      <div class="row">
        <div style="min-width:240px">
          <div><small>SeÃ§ili kontrat</small></div>
          <div id="contractAddr" class="mono">â€”</div>
        </div>
        <div>
          <button id="connect" class="btn btn-outline">CÃ¼zdanÄ± BaÄŸla</button>
          <button id="ping" class="btn btn-ghost" disabled>Ping</button>
        </div>
      </div>

      <div class="row kpi">
        <div class="pill"><small>BaÄŸlÄ± cÃ¼zdan: </small><span id="account" class="mono">â€”</span></div>
        <div class="pill"><small>SayÄ±m: </small><span id="counter">â€”</span></div>
      </div>

      <div style="margin-top:8px">
        <small>Durum: <span id="status">HazÄ±r</span></small><br/>
        <small>Tx: <a id="tx" href="#" target="_blank" rel="noreferrer">â€”</a></small>
      </div>
    </div>

    <script>
      (function() {
        const CHAIN_ID_HEX = "0x2105"; // Base Mainnet 8453
        const RPC_URL = "https://mainnet.base.org";

        // DOM
        const statusEl = document.getElementById("status");
        const accountEl = document.getElementById("account");
        const counterEl = document.getElementById("counter");
        const txEl = document.getElementById("tx");
        const connectBtn = document.getElementById("connect");
        const pingBtn = document.getElementById("ping");
        const contractAddrEl = document.getElementById("contractAddr");
        const contractsWrap = document.getElementById("contracts");

        // ABI (PingOnce tipi). BazÄ± kontratlarda uniquePings/hasPinged yoksa try/catch ile atlanÄ±r.
        const ABI = [
          {"inputs":[],"name":"ping","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[],"name":"uniquePings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
          {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasPinged","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
          {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"}],"name":"Ping","type":"event"}
        ];

        // State
        let currentAddress = document.querySelector(".contract-btn.active").dataset.addr;
        let provider, signer, contract;

        contractAddrEl.textContent = currentAddress;

        // Kontrat butonlarÄ± tÄ±klama
        contractsWrap.addEventListener("click", async (e) => {
          const btn = e.target.closest(".contract-btn");
          if (!btn) return;
          document.querySelectorAll(".contract-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentAddress = btn.dataset.addr;
          contractAddrEl.textContent = currentAddress;
          await initContract(); // seÃ§ince gÃ¼ncelle
        });

        async function ensureBaseNetwork() {
          const eth = window.ethereum;
          if (!eth) throw new Error("CÃ¼zdan bulunamadÄ±");
          const chainId = await eth.request({ method: "eth_chainId" });
          if (chainId !== CHAIN_ID_HEX) {
            try {
              await eth.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: CHAIN_ID_HEX }],
              });
            } catch (err) {
              if (err.code === 4902) {
                await eth.request({
                  method: "wallet_addEthereumChain",
                  params: [{
                    chainId: CHAIN_ID_HEX,
                    chainName: "Base Mainnet",
                    nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                    rpcUrls: [RPC_URL],
                    blockExplorerUrls: ["https://basescan.org/"],
                  }],
                });
              } else {
                throw err;
              }
            }
          }
        }

        async function initContract() {
          try {
            if (!provider) {
              // read-only sayaÃ§ iÃ§in public provider
              const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
              contract = new ethers.Contract(currentAddress, ABI, rp);
              await refreshCounter(true);
              pingBtn.disabled = true;
              return;
            }
            await ensureBaseNetwork();
            contract = new ethers.Contract(currentAddress, ABI, signer);
            await refreshCounter();
            await applyHasPingedGate();
            pingBtn.disabled = false;
          } catch (e) {
            console.warn("initContract uyarÄ±:", e);
            counterEl.textContent = "â€”";
            pingBtn.disabled = false; // en az ping'e izin ver
            statusEl.textContent = "BaÄŸlandÄ± (sayaÃ§/hasPinged desteklenmeyebilir).";
          }
        }

        async function applyHasPingedGate() {
          try {
            const me = await signer.getAddress();
            if (typeof contract.hasPinged !== "function") return;
            const already = await contract.hasPinged(me);
            if (already) {
              pingBtn.disabled = true;
              statusEl.textContent = "Bu cÃ¼zdan zaten ping attÄ± âœ…";
            } else {
              pingBtn.disabled = false;
              statusEl.textContent = "BaÄŸlandÄ±. Ping atabilirsin.";
            }
          } catch {/* sessiz */}
        }

        async function refreshCounter(readOnlyOnly=false) {
          try {
            if (typeof contract.uniquePings !== "function") { counterEl.textContent = "â€”"; return; }
            const v = await contract.uniquePings();
            counterEl.textContent = v.toString() + " unique pings";
          } catch (e) {
            if (!readOnlyOnly) {
              try {
                const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
                const rc = new ethers.Contract(currentAddress, ABI, rp);
                const v = await rc.uniquePings();
                counterEl.textContent = v.toString() + " unique pings";
              } catch { counterEl.textContent = "â€”"; }
            } else {
              counterEl.textContent = "â€”";
            }
          }
        }

        async function connect() {
          if (!window.ethereum) {
            alert("LÃ¼tfen MetaMask (veya bir EVM cÃ¼zdanÄ±) kur.");
            return;
          }
          statusEl.textContent = "CÃ¼zdan baÄŸlantÄ±sÄ± bekleniyorâ€¦";
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          accountEl.textContent = accounts[0] || "â€”";
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();

          await initContract();

          if (window.ethereum && !window.__basePingBound) {
            window.__basePingBound = true;
            window.ethereum.on("accountsChanged", () => connect());
            window.ethereum.on("chainChanged", () => location.reload());
          }
        }

        async function ping() {
          try {
            if (!contract || !signer) { statusEl.textContent = "Ã–nce cÃ¼zdan baÄŸla."; return; }
      
            // ðŸ”¹ AÄž KONTROLÃœ: Base deÄŸilse Ã¶neri + otomatik switch
            if (window.ethereum) {
              const chainId = await window.ethereum.request({ method: "eth_chainId" });
              if (chainId !== CHAIN_ID_HEX) {
                const ok = window.confirm("Åžu an Base aÄŸÄ±nda deÄŸilsin. Base Mainnet'e geÃ§elim mi?");
                if (!ok) {
                  statusEl.textContent = "Base aÄŸÄ±na geÃ§meden ping atÄ±lamaz.";
                  return;
                }
                statusEl.textContent = "Base aÄŸÄ±na geÃ§iliyorâ€¦";
                await ensureBaseNetwork();
                // aÄŸ deÄŸiÅŸti â†’ kontratÄ± signer ile yeniden baÄŸla
                contract = new ethers.Contract(currentAddress, ABI, signer);
                await refreshCounter(); // sayaÃ§ gÃ¼ncelle
              }
            }
      
            const me = await signer.getAddress();
      
            // (Varsa) tek-sefer kapÄ±sÄ±
            try {
              if (typeof contract.hasPinged === "function") {
                const already = await contract.hasPinged(me);
                if (already) {
                  pingBtn.disabled = true;
                  statusEl.textContent = "Bu cÃ¼zdan zaten ping attÄ± âœ…";
                  return;
                }
              }
            } catch {}
      
            // SimÃ¼lasyon: geÃ§mezse gÃ¶ndermiyoruz
            try {
              await contract.callStatic.ping({ from: me });
            } catch {
              statusEl.textContent = "Kontrat bu Ã§aÄŸrÄ±yÄ± bu aÄŸda/hesapla reddediyor.";
              return;
            }
      
            // Gas tahmini: baÅŸarÄ±sÄ±zsa iptal
            let gasLimit;
            try {
              const est = await contract.estimateGas.ping({ from: me });
              gasLimit = est.mul(120).div(100);
            } catch {
              statusEl.textContent = "Gas tahmini yapÄ±lamadÄ±; gÃ¶nderim iptal edildi.";
              return;
            }
      
            statusEl.textContent = "Ä°ÅŸlem gÃ¶nderiliyorâ€¦ CÃ¼zdandan onayla.";
            const tx = await contract.ping({ gasLimit });
            txEl.textContent = tx.hash;
            txEl.href = `https://basescan.org/tx/${tx.hash}`;
            statusEl.textContent = "Onay bekleniyorâ€¦";
            await tx.wait();
            statusEl.textContent = "OnaylandÄ±! TeÅŸekkÃ¼rler.";
            await refreshCounter();
            await applyHasPingedGate();
          } catch (e) {
            const msg = (e?.data?.message || e?.message || "").toLowerCase();
            if (msg.includes("user rejected")) {
              statusEl.textContent = "Ä°ÅŸlem iptal edildi.";
            } else if (msg.includes("already")) {
              statusEl.textContent = "Bu cÃ¼zdan zaten ping attÄ± âœ…";
              pingBtn.disabled = true;
            } else {
              statusEl.textContent = "Ä°ÅŸlem reddedildi/baÅŸarÄ±sÄ±z: " + (e?.data?.message || e?.message || "Bilinmeyen hata");
            }
          }
        }
        
        // Events
        connectBtn.addEventListener("click", connect);
        pingBtn.addEventListener("click", ping);

        // Ä°lk yÃ¼klemede seÃ§ili kontrat adresini ve sayaÃ§Ä± dene
        (async () => {
          contractAddrEl.textContent = currentAddress;
          try {
            const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
            const rc = new ethers.Contract(currentAddress, ABI, rp);
            const v = await rc.uniquePings().catch(()=>null);
            if (v !== null) counterEl.textContent = v.toString() + " unique pings";
          } catch {}
        })();
      })();
    </script>
  </body>
</html>
