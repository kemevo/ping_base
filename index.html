<!doctype html>
<html lang="tr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Base Ping (çoklu kontrat)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0f172a; color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0 }
      .card { background:rgba(255,255,255,.06); padding:24px; border-radius:16px; width: min(92vw, 560px); box-shadow: 0 15px 40px rgba(0,0,0,.3) }
      .row { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:10px 0; flex-wrap:wrap }
      .btn { background:rgba(255,255,255,.10); border:none; padding:10px 14px; border-radius:12px; color:#fff; cursor:pointer }
      .btn:disabled { opacity:.5; cursor:not-allowed }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; word-break: break-all }
      small { opacity:.7 }
      a { color:#a5b4fc }
      select { background:rgba(255,255,255,.10); color:#fff; border:none; border-radius:10px; padding:8px 10px }
      label { font-size:12px; opacity:.8 }
      .muted { opacity:.7 }
    </style>
    <!-- Ethers v5 UMD (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  </head>
  <body>
    <div class="card">
      <h2 style="margin:0 0 6px">Base Ping</h2>
      <p class="muted" style="margin:0 0 16px">
        <strong>Ping</strong> butonuna tıkla → cüzdan onayı → seçili kontrattaki <code>ping()</code> çağrılır.
        Her cüzdan 1 kez (kontratın <code>hasPinged</code> kontrolü varsa).
      </p>

      <div class="row">
        <div>
          <div><small>Bağlı cüzdan</small></div>
          <div id="account" class="mono">—</div>
        </div>
        <button id="connect" class="btn">Cüzdanı Bağla</button>
      </div>

      <div class="row" style="gap:8px">
        <div style="flex:1 1 240px">
          <label for="contractSel">Kontrat (Base Mainnet)</label><br/>
          <select id="contractSel" style="width:100%">
            <!-- Aşağıdaki 3 adres eklendi -->
            <option value="0x88b04a6ce778b3eab658a6f5692a4714a60eb136">0x88b0...b136</option>
            <option value="0xbea9b733313312ffaaf587a8b4523c2466fc20a3">0xbea9...20a3</option>
            <option value="0xf5a60f454108411c5ba5a4dad5998793781c7565">0xf5a6...7565</option>
          </select>
        </div>
        <div style="flex:1 1 240px">
          <div><small>Seçili kontrat adresi</small></div>
          <div id="contractAddr" class="mono"></div>
        </div>
      </div>

      <div class="row">
        <button id="ping" class="btn" disabled>Ping</button>
        <div><small id="counter">—</small></div>
      </div>

      <div style="margin-top:8px">
        <small>Durum: <span id="status">Hazır</span></small><br/>
        <small>Tx: <a id="tx" href="#" target="_blank" rel="noreferrer">—</a></small>
      </div>
    </div>

    <script type="text/javascript">
      (function() {
        const CHAIN_ID_HEX = "0x2105"; // 8453 Base Mainnet
        const RPC_URL = "https://mainnet.base.org";

        // DOM
        const accountEl = document.getElementById("account");
        const statusEl = document.getElementById("status");
        const txEl = document.getElementById("tx");
        const counterEl = document.getElementById("counter");
        const connectBtn = document.getElementById("connect");
        const pingBtn = document.getElementById("ping");
        const contractAddrEl = document.getElementById("contractAddr");
        const contractSel = document.getElementById("contractSel");

        // Çoklu kontrat desteği
        function currentContractAddress() {
          return contractSel.value;
        }
        contractAddrEl.textContent = currentContractAddress();
        contractSel.addEventListener("change", async () => {
          contractAddrEl.textContent = currentContractAddress();
          await initContract(); // kontrat değişince yeniden bağlan
        });

        // PingOnce ABI (uniquePings/hasPinged/Ping). Bazı kontratlar bu fonksiyonları içermiyorsa
        // çağrıları try/catch ile sarıyoruz ve özellikleri gizliyoruz.
        const ABI = [
          {"inputs":[],"name":"ping","outputs":[],"stateMutability":"nonpayable","type":"function"},
          {"inputs":[],"name":"uniquePings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
          {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"hasPinged","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
          {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"count","type":"uint256"}],"name":"Ping","type":"event"}
        ];

        let provider, signer, contract;

        async function ensureBaseNetwork() {
          const eth = window.ethereum;
          if (!eth) throw new Error("Cüzdan bulunamadı");
          const chainId = await eth.request({ method: "eth_chainId" });
          if (chainId !== CHAIN_ID_HEX) {
            try {
              await eth.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: CHAIN_ID_HEX }],
              });
            } catch (err) {
              if (err.code === 4902) {
                // Ağ yüklü değilse ekle
                await eth.request({
                  method: "wallet_addEthereumChain",
                  params: [{
                    chainId: CHAIN_ID_HEX,
                    chainName: "Base Mainnet",
                    nativeCurrency: { name: "Ether", symbol: "ETH", decimals: 18 },
                    rpcUrls: [RPC_URL],
                    blockExplorerUrls: ["https://basescan.org/"],
                  }],
                });
              } else {
                throw err;
              }
            }
          }
        }

        async function initContract() {
          try {
            if (!provider) {
              // read-only sayacı gösterebilmek için provider yoksa RPC üzerinden bağlan
              const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
              contract = new ethers.Contract(currentContractAddress(), ABI, rp);
              await refreshCounter(true);
              pingBtn.disabled = true;
              return;
            }
            await ensureBaseNetwork();
            contract = new ethers.Contract(currentContractAddress(), ABI, signer);
            await refreshCounter();
            await applyHasPingedGate();
            pingBtn.disabled = false;
          } catch (e) {
            // ABI uymuyorsa sayacı/kapıları sakla ama ping deneyine izin ver
            console.warn("initContract uyarı:", e);
            counterEl.textContent = "—";
            pingBtn.disabled = false;
            statusEl.textContent = "Bağlandı (sayaç/hasPinged desteklenmiyor olabilir).";
          }
        }

        async function applyHasPingedGate() {
          try {
            const me = await signer.getAddress();
            if (typeof contract.hasPinged !== "function") return; // bu fonksiyon yoksa geç
            const already = await contract.hasPinged(me);
            if (already) {
              pingBtn.disabled = true;
              statusEl.textContent = "Bu cüzdan zaten ping attı ✅";
            } else {
              pingBtn.disabled = false;
              statusEl.textContent = "Bağlandı. Ping atabilirsin.";
            }
          } catch {
            // hasPinged yoksa sessiz geç
          }
        }

        async function connect() {
          if (!window.ethereum) {
            alert("Lütfen MetaMask (veya bir EVM cüzdanı) kur.");
            return;
          }
          statusEl.textContent = "Cüzdan bağlantısı bekleniyor…";
          const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
          accountEl.textContent = accounts[0] || "—";
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();

          await initContract();

          // ağ/hesap değişimlerini dinle
          if (window.ethereum && !window.__basePingBound) {
            window.__basePingBound = true;
            window.ethereum.on("accountsChanged", () => connect());
            window.ethereum.on("chainChanged", () => location.reload());
          }
        }

        async function refreshCounter(readOnlyIfNeeded = false) {
          try {
            if (typeof contract.uniquePings !== "function") {
              counterEl.textContent = "—";
              return;
            }
            const v = await contract.uniquePings();
            counterEl.textContent = v.toString() + " unique pings";
          } catch (e) {
            if (!readOnlyIfNeeded) {
              // write provider ile okunamadıysa read-only dene
              try {
                const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
                const rc = new ethers.Contract(currentContractAddress(), ABI, rp);
                const v = await rc.uniquePings();
                counterEl.textContent = v.toString() + " unique pings";
              } catch {
                counterEl.textContent = "—";
              }
            } else {
              counterEl.textContent = "—";
            }
          }
        }

        async function ping() {
          try {
            if (!contract || !signer) {
              statusEl.textContent = "Önce cüzdan bağla.";
              return;
            }
            await ensureBaseNetwork(); // yazmadan önce son kontrol
            statusEl.textContent = "İşlem gönderiliyor… Cüzdandan onayla.";
            const tx = await contract.ping(); // sadece ping
            txEl.textContent = tx.hash;
            txEl.href = `https://basescan.org/tx/${tx.hash}`;
            statusEl.textContent = "Onay bekleniyor…";
            await tx.wait();
            statusEl.textContent = "Onaylandı! Teşekkürler.";
            await refreshCounter();
            // ping sonrası tekrar kapı
            await applyHasPingedGate();
          } catch (e) {
            const msg = (e?.data?.message || e?.message || "").toLowerCase();
            if (msg.includes("already pinged")) {
              statusEl.textContent = "Bu cüzdan zaten ping attı ✅";
              pingBtn.disabled = true;
            } else if (msg.includes("user rejected")) {
              statusEl.textContent = "İşlem iptal edildi.";
            } else {
              statusEl.textContent = "İşlem reddedildi/başarısız: " + (e?.data?.message || e?.message || "Bilinmeyen hata");
            }
          }
        }

        connectBtn.addEventListener("click", connect);
        pingBtn.addEventListener("click", ping);

        // Sayfa açılışında seçili kontrat adresini göster ve read-only sayaç dene
        (async () => {
          try {
            const rp = new ethers.providers.JsonRpcProvider(RPC_URL);
            const rc = new ethers.Contract(currentContractAddress(), ABI, rp);
            const v = await rc.uniquePings().catch(()=>null);
            contractAddrEl.textContent = currentContractAddress();
            if (v !== null) counterEl.textContent = v.toString() + " unique pings";
          } catch {
            /* ignore */
          }
        })();
      })();
    </script>
  </body>
</html>
